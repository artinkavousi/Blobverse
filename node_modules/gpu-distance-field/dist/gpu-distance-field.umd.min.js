!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["gpu-distance-field"]={})}(this,(function(t){"use strict";function e(t){if(!t)throw new Error("Assertion failed.")}var i,r;!function(t){t.Rect=class{constructor(t=0,e=0,i=0,r=0){this.x=t,this.y=e,this.width=i,this.height=r}set(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}};class e{constructor(t,e,i,r){this.redF=t,this.greenF=e,this.blueF=i,this.alphaF=r}}let i,r,s,n,a;e.TRANSPARENT=new e(0,0,0,0),t.Color=e,function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SOURCE_COLOR=2]="SOURCE_COLOR",t[t.TARGET_COLOR=3]="TARGET_COLOR",t[t.INVERSE_SOURCE_COLOR=4]="INVERSE_SOURCE_COLOR",t[t.INVERSE_TARGET_COLOR=5]="INVERSE_TARGET_COLOR",t[t.SOURCE_ALPHA=6]="SOURCE_ALPHA",t[t.TARGET_ALPHA=7]="TARGET_ALPHA",t[t.INVERSE_SOURCE_ALPHA=8]="INVERSE_SOURCE_ALPHA",t[t.INVERSE_TARGET_ALPHA=9]="INVERSE_TARGET_ALPHA",t[t.CONSTANT=10]="CONSTANT",t[t.INVERSE_CONSTANT=11]="INVERSE_CONSTANT"}(i=t.BlendOperation||(t.BlendOperation={})),function(t){t[t.TRIANGLES=0]="TRIANGLES",t[t.TRIANGLE_STRIP=1]="TRIANGLE_STRIP"}(r=t.Primitive||(t.Primitive={}));function o(t){return t==s.FLOAT?4:1}t.Context=class{setCopyBlendState(){this.setBlendState(i.ONE,i.ZERO)}setAddBlendState(){this.setBlendState(i.ONE,i.ONE)}setPremultipliedBlendState(){this.setBlendState(i.ONE,i.INVERSE_SOURCE_ALPHA)}setUnpremultipliedBlendState(){this.setBlendState(i.SOURCE_ALPHA,i.INVERSE_SOURCE_ALPHA)}},function(t){t[t.FLOAT=0]="FLOAT",t[t.BYTE=1]="BYTE"}(s=t.AttributeType||(t.AttributeType={})),t.attributeByteLength=o;class h{constructor(t,e,i,r){this.name=t,this.type=e,this.count=i,this.byteOffset=r}}t.Attribute=h;t.VertexFormat=class{constructor(){this._attributes=[],this._stride=0}get attributes(){return this._attributes}get stride(){return this._stride}add(t,e,i){return this.attributes.push(new h(t,e,i,this.stride)),this._stride+=i*o(e),this}};t.VertexBuffer=class{uploadFloat32Array(t){this.upload(new Uint8Array(t.buffer),0)}uploadFloats(t){this.uploadFloat32Array(new Float32Array(t))}},function(t){t[t.NEAREST=0]="NEAREST",t[t.LINEAR=1]="LINEAR"}(n=t.PixelFilter||(t.PixelFilter={})),function(t){t[t.REPEAT=0]="REPEAT",t[t.CLAMP=1]="CLAMP"}(a=t.PixelWrap||(t.PixelWrap={}));class _{constructor(t,e,i){this.minFilter=t,this.magFilter=e,this.wrap=i}}_.LINEAR_CLAMP=new _(n.LINEAR,n.LINEAR,a.CLAMP),_.LINEAR_MIN_NEAREST_MAG_CLAMP=new _(n.LINEAR,n.NEAREST,a.CLAMP),_.NEAREST_CLAMP=new _(n.NEAREST,n.NEAREST,a.CLAMP),t.TextureFormat=_}(i||(i={})),function(t){class r extends i.Context{constructor(t=document.createElement("canvas")){super(),this._attributeCount=0,this._blendOperations=0,this._contextResetHandlers=[],this._currentClearColor=i.Color.TRANSPARENT,this._currentRenderTarget=null,this._defaultViewport=new i.Rect,this._forceStateUpdate=!0,this._generation=1,this._height=0,this._oldBlendOperations=0,this._oldRenderTarget=null,this._oldViewport=new i.Rect,this._width=0,this.handleWebglContextRestored=()=>{this._attributeCount=0,this._currentClearColor=i.Color.TRANSPARENT,this._forceStateUpdate=!0,this._generation++;for(let t of this._contextResetHandlers)t()},this.ANGLE_instanced_arrays=null,this.ANGLE_instanced_arrays_generation=-1;let e=t.getContext("webgl",{alpha:!1,antialias:!1,depth:!1,preserveDrawingBuffer:!0,stencil:!1});if(null==e)throw new Error("Setup failure");this._gl=e;let r=t.style;t.width=0,t.height=0,r.width=r.height="0",t.addEventListener("webglcontextlost",t=>{t.preventDefault()}),t.addEventListener("webglcontextrestored",this.handleWebglContextRestored),this._blendOperationMap={[i.BlendOperation.ZERO]:this._gl.ZERO,[i.BlendOperation.ONE]:this._gl.ONE,[i.BlendOperation.SOURCE_COLOR]:this._gl.SRC_COLOR,[i.BlendOperation.TARGET_COLOR]:this._gl.DST_COLOR,[i.BlendOperation.INVERSE_SOURCE_COLOR]:this._gl.ONE_MINUS_SRC_COLOR,[i.BlendOperation.INVERSE_TARGET_COLOR]:this._gl.ONE_MINUS_DST_COLOR,[i.BlendOperation.SOURCE_ALPHA]:this._gl.SRC_ALPHA,[i.BlendOperation.TARGET_ALPHA]:this._gl.DST_ALPHA,[i.BlendOperation.INVERSE_SOURCE_ALPHA]:this._gl.ONE_MINUS_SRC_ALPHA,[i.BlendOperation.INVERSE_TARGET_ALPHA]:this._gl.ONE_MINUS_DST_ALPHA,[i.BlendOperation.CONSTANT]:this._gl.CONSTANT_COLOR,[i.BlendOperation.INVERSE_CONSTANT]:this._gl.ONE_MINUS_CONSTANT_COLOR}}get widthInPixels(){return this._width}get heightInPixels(){return this._height}testContextLoss(){this.handleWebglContextRestored()}get gl(){return this._gl}get generation(){return this._generation}addContextResetHandler(t){var e,i;e=this._contextResetHandlers,i=t,-1===e.indexOf(i)&&e.push(i)}removeContextResetHandler(t){!function(t,e){const i=t.indexOf(e);-1!==i&&t.splice(i,1)}(this._contextResetHandlers,t)}get currentRenderTarget(){return this._currentRenderTarget}beginFrame(){this.setRenderTarget(null)}endFrame(){}setBlendState(t,e){this._blendOperations=r._packBlendModes(t,e)}setViewport(t,e,i,r){(null!=this._currentRenderTarget?this._currentRenderTarget.viewport:this._defaultViewport).set(t,e,i,r)}get viewport(){return null!=this._currentRenderTarget?this._currentRenderTarget.viewport:this._defaultViewport}get renderTargetWidthInPixels(){return null!=this._currentRenderTarget?this._currentRenderTarget.viewport.width:this._width}get renderTargetHeightInPixels(){return null!=this._currentRenderTarget?this._currentRenderTarget.viewport.height:this._height}draw(t,e,r){this._updateRenderTargetAndViewport(),d.from(e).prepare(),f.from(r).prepare(),this._updateFormat(e.format),this._updateBlendState(),this._gl.drawArrays(t==i.Primitive.TRIANGLES?this._gl.TRIANGLES:this._gl.TRIANGLE_STRIP,0,Math.floor(r.byteCount/e.format.stride)),this._forceStateUpdate=!1}resize(t,e,i,r){let s=this._gl.canvas;const n=s.getBoundingClientRect();if(this._width===i&&this._height===e&&n.width===i&&n.height===r)return;let a=s.style;s.width=t,s.height=e,a.width=i+"px",a.height=r+"px",this.setViewport(0,0,t,e),this._width=t,this._height=e}clear(t){this._updateRenderTargetAndViewport(),this._updateBlendState(),t!=this._currentClearColor&&(this._gl.clearColor(t.redF,t.greenF,t.blueF,t.alphaF),this._currentClearColor=t),this._gl.clear(this._gl.COLOR_BUFFER_BIT)}setRenderTarget(t){this._currentRenderTarget=p.from(t)}createMaterial(t,e,i){return new d(this,t,e,i)}createVertexBuffer(t){return e(t>0&&t%4==0),new f(this,t)}createTexture(t,e,i,r){return new g(this,t,e,i,r)}createRenderTarget(t){return new p(this,g.from(t))}getANGLE_instanced_arrays(){if(this.ANGLE_instanced_arrays_generation!==this._generation&&(this.ANGLE_instanced_arrays=null),!this.ANGLE_instanced_arrays&&(this.ANGLE_instanced_arrays=this.gl.getExtension("ANGLE_instanced_arrays"),!this.ANGLE_instanced_arrays))throw new Error("Failed to get extension ANGLE_instanced_arrays");return this.ANGLE_instanced_arrays}_updateRenderTargetAndViewport(){let t=this._currentRenderTarget,e=null!=t?t.viewport:this._defaultViewport,i=this._gl;(this._forceStateUpdate||this._oldRenderTarget!=t)&&(i.bindFramebuffer(i.FRAMEBUFFER,t?t.framebuffer:null),this._oldRenderTarget=t),!this._forceStateUpdate&&this._oldViewport.equals(e)||(i.viewport(e.x,this.renderTargetHeightInPixels-e.y-e.height,e.width,e.height),this._oldViewport.set(e.x,e.y,e.width,e.height))}_updateBlendState(){if(this._forceStateUpdate||this._oldBlendOperations!=this._blendOperations){let t=this._gl,i=this._blendOperations,s=this._oldBlendOperations,n=15&i,a=i>>4;e(n in this._blendOperationMap),e(a in this._blendOperationMap),i==r.COPY_BLEND_OPERATIONS?t.disable(t.BLEND):((this._forceStateUpdate||s==r.COPY_BLEND_OPERATIONS)&&t.enable(t.BLEND),t.blendFunc(this._blendOperationMap[n],this._blendOperationMap[a])),this._oldBlendOperations=i}}_updateFormat(t){let e=this._gl,r=t.attributes,s=r.length;for(let n=0;n<s;n++){let s=r[n],a=s.type==i.AttributeType.BYTE;e.vertexAttribPointer(n,s.count,a?e.UNSIGNED_BYTE:e.FLOAT,a,t.stride,s.byteOffset)}for(;this._attributeCount<s;)e.enableVertexAttribArray(this._attributeCount),this._attributeCount++;for(;this._attributeCount>s;)this._attributeCount--,e.disableVertexAttribArray(this._attributeCount);this._attributeCount=s}getWebGLInfo(){const t=this.gl.getExtension("WEBGL_debug_renderer_info");return{renderer:t?this.gl.getParameter(t.UNMASKED_RENDERER_WEBGL):null,vendor:t?this.gl.getParameter(t.UNMASKED_VENDOR_WEBGL):null,version:this.gl.getParameter(this.gl.VERSION)}}static from(t){return e(null==t||t instanceof r),t}static _packBlendModes(t,e){return t|e<<4}}r.COPY_BLEND_OPERATIONS=r._packBlendModes(i.BlendOperation.ONE,i.BlendOperation.ZERO),t.Context=r;class s{constructor(t,e,i=0,r=null,s=!0){this._material=t,this._name=e,this._generation=i,this._location=r,this._isDirty=s}get location(){let t=r.from(this._material.context);if(this._generation!=t.generation){this._location=t.gl.getUniformLocation(this._material.program,this._name),this._generation=t.generation;{let i=this._material.program,r=t.gl;for(let t=0,s=r.getProgramParameter(i,r.ACTIVE_UNIFORMS);t<s;t++){let s=r.getActiveUniform(i,t);if(s&&s.name==this._name)switch(e(1==s.size),s.type){case r.FLOAT:e(this instanceof n);break;case r.BOOL:e(this instanceof a);break;case r.FLOAT_MAT3:e(this instanceof l);break;case r.FLOAT_VEC2:e(this instanceof h);break;case r.FLOAT_VEC3:e(this instanceof _);break;case r.FLOAT_VEC4:e(this instanceof u);break;case r.INT:e(this instanceof o);break;case r.SAMPLER_2D:e(this instanceof c);break;default:e(!1)}}}}if(!this._location)throw new Error("Failed to get uniform location");return this._location}}class n extends s{constructor(){super(...arguments),this._x=0}set(t){t!=this._x&&(this._x=t,this._isDirty=!0)}prepare(){let t=r.from(this._material.context);(this._generation!=t.generation||this._isDirty)&&(t.gl.uniform1f(this.location,this._x),this._isDirty=!1)}}class a extends s{constructor(){super(...arguments),this._x=!1}set(t){t!=this._x&&(this._x=t,this._isDirty=!0)}prepare(){let t=r.from(this._material.context);(this._generation!=t.generation||this._isDirty)&&(t.gl.uniform1i(this.location,this._x?1:0),this._isDirty=!1)}}class o extends s{constructor(){super(...arguments),this._x=0}set(t){t!=this._x&&(this._x=t,this._isDirty=!0)}prepare(){let t=r.from(this._material.context);(this._generation!=t.generation||this._isDirty)&&(t.gl.uniform1i(this.location,this._x),this._isDirty=!1)}}class h extends s{constructor(){super(...arguments),this._x=0,this._y=0}set(t,e){t==this._x&&e==this._y||(this._x=t,this._y=e,this._isDirty=!0)}prepare(){let t=r.from(this._material.context);(this._generation!=t.generation||this._isDirty)&&(t.gl.uniform2f(this.location,this._x,this._y),this._isDirty=!1)}}class _ extends s{constructor(){super(...arguments),this._x=0,this._y=0,this._z=0}set(t,e,i){t==this._x&&e==this._y&&i==this._z||(this._x=t,this._y=e,this._z=i,this._isDirty=!0)}prepare(){let t=r.from(this._material.context);(this._generation!=t.generation||this._isDirty)&&(t.gl.uniform3f(this.location,this._x,this._y,this._z),this._isDirty=!1)}}class u extends s{constructor(){super(...arguments),this._x=0,this._y=0,this._z=0,this._w=0}set(t,e,i,r){t==this._x&&e==this._y&&i==this._z&&r==this._w||(this._x=t,this._y=e,this._z=i,this._w=r,this._isDirty=!0)}prepare(){let t=r.from(this._material.context);(this._generation!=t.generation||this._isDirty)&&(t.gl.uniform4f(this.location,this._x,this._y,this._z,this._w),this._isDirty=!1)}}class l extends s{constructor(){super(...arguments),this._values=[1,0,0,0,1,0,0,0,1]}set(t,e,i,r,s,n,a,o,h){l._cachedValues[0]=t,l._cachedValues[1]=r,l._cachedValues[2]=a,l._cachedValues[3]=e,l._cachedValues[4]=s,l._cachedValues[5]=o,l._cachedValues[6]=i,l._cachedValues[7]=n,l._cachedValues[8]=h;for(let t=0;t<9;t++)if(l._cachedValues[t]!=this._values[t]){let t=this._values;this._values=l._cachedValues,l._cachedValues=t,this._isDirty=!0;break}}prepare(){let t=r.from(this._material.context);(this._generation!=t.generation||this._isDirty)&&(t.gl.uniformMatrix3fv(this.location,!1,this._values),this._isDirty=!1)}}l._cachedValues=[1,0,0,0,1,0,0,0,1];class c extends s{constructor(){super(...arguments),this._texture=null,this._index=-1}set(t,e){this._texture==t&&this._index==e||(this._texture=g.from(t),this._index=e,this._isDirty=!0)}prepare(){let t=r.from(this._material.context),i=t.gl;e(null==this._texture||null==t.currentRenderTarget||this._texture!=t.currentRenderTarget.texture),(this._generation!=t.generation||this._isDirty)&&(i.uniform1i(this.location,this._index),this._isDirty=!1),i.activeTexture(function(t,i){return e(i>=0&&i<=31),t.TEXTURE0+i}(i,this._index)),i.bindTexture(i.TEXTURE_2D,null!=this._texture&&this._texture.width>0&&this._texture.height>0?this._texture.texture:null)}}class d{constructor(t,e,i,r,s={},n=[],a=0,o=null){this._context=t,this._format=e,this._vertexSource=i,this._fragmentSource=r,this._uniformsMap=s,this._uniformsList=n,this._generation=a,this._program=o}get context(){return this._context}get format(){return this._format}get vertexSource(){return this._vertexSource}get fragmentSource(){return this._fragmentSource}free(){this._program&&this._context.gl.deleteProgram(this._program),this._generation=0}setUniformBool(t,i){let r=this._uniformsMap[t]||null;null==r&&(r=new a(this,t),this._uniformsMap[t]=r,this._uniformsList.push(r)),e(r instanceof a),r.set(i)}setUniformFloat(t,i){let r=this._uniformsMap[t]||null;null==r&&(r=new n(this,t),this._uniformsMap[t]=r,this._uniformsList.push(r)),e(r instanceof n),r.set(i)}setUniformInt(t,i){let r=this._uniformsMap[t]||null;null==r&&(r=new o(this,t),this._uniformsMap[t]=r,this._uniformsList.push(r)),e(r instanceof o),r.set(i)}setUniformVec2(t,i,r){let s=this._uniformsMap[t]||null;null==s&&(s=new h(this,t),this._uniformsMap[t]=s,this._uniformsList.push(s)),e(s instanceof h),s.set(i,r)}setUniformVec3(t,i,r,s){let n=this._uniformsMap[t]||null;null==n&&(n=new _(this,t),this._uniformsMap[t]=n,this._uniformsList.push(n)),e(n instanceof _),n.set(i,r,s)}setUniformVec4(t,i,r,s,n){let a=this._uniformsMap[t]||null;null==a&&(a=new u(this,t),this._uniformsMap[t]=a,this._uniformsList.push(a)),e(a instanceof u),a.set(i,r,s,n)}setUniformMat3(t,i,r,s,n,a,o,h,_,u){let c=this._uniformsMap[t]||null;null==c&&(c=new l(this,t),this._uniformsMap[t]=c,this._uniformsList.push(c)),e(c instanceof l),c.set(i,r,s,n,a,o,h,_,u)}setUniformSampler(t,i,r){let s=this._uniformsMap[t]||null;null==s&&(s=new c(this,t),this._uniformsMap[t]=s,this._uniformsList.push(s)),e(s instanceof c),s.set(i,r)}get program(){let t=this._context.gl;if(this._generation!=this._context.generation){this._program=t.createProgram(),this._compileShader(t,t.VERTEX_SHADER,this.vertexSource),this._compileShader(t,t.FRAGMENT_SHADER,this.fragmentSource);let i=this.format.attributes;for(let e=0;e<i.length;e++)t.bindAttribLocation(this._program,e,i[e].name);if(t.linkProgram(this._program),!t.getProgramParameter(this._program,t.LINK_STATUS))throw new Error(""+t.getProgramInfoLog(this._program));this._generation=this._context.generation;for(let r of i)for(let i=0,s=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);i<s;i++){let s=t.getActiveAttrib(this.program,i);if(s&&s.name==r.name)switch(e(1==s.size),r.count){case 1:e(s.type==t.FLOAT);break;case 2:e(s.type==t.FLOAT_VEC2);break;case 3:e(s.type==t.FLOAT_VEC3);break;case 4:e(s.type==t.FLOAT_VEC4);break;default:e(!1)}}}return this._program}prepare(){this._context.gl.useProgram(this.program);for(let t of this._uniformsList)t.prepare()}_compileShader(t,e,i){let r=t.createShader(e);if(!r)throw new Error("Failed to create shader");if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(""+t.getShaderInfoLog(r));if(!this._program)throw new Error("Tried to attach shader before program was created");t.attachShader(this._program,r)}static from(t){return e(null==t||t instanceof d),t}}class f extends i.VertexBuffer{constructor(t,e){super(),this._generation=0,this._buffer=null,this._bytes=null,this._isDirty=!0,this._dirtyMin=f.INT_MAX,this._dirtyMax=0,this._totalMin=f.INT_MAX,this._totalMax=0,this._byteCount=0,this._context=t,this._byteCount=e,this._bytes=new Uint8Array(e)}get context(){return this._context}get byteCount(){return this._byteCount}move(t,i,r){e(r>=0),e(0<=t&&t+r<=this._byteCount),e(0<=i&&i+r<=this._byteCount),this._bytes&&t!=i&&0!=r&&(this._bytes.set(this._bytes.subarray(t,this._byteCount),i),this._growDirtyRegion(Math.min(t,i),Math.max(t,i)+r))}upload(t,i=0){e(0<=i&&i+t.length<=this._byteCount),e(null!=this._bytes),this._bytes.set(t,i),this._growDirtyRegion(i,i+t.length)}free(){this._buffer&&this._context.gl.deleteBuffer(this._buffer),this._generation=0}prepare(){let t=this._context.gl;this._generation!==this._context.generation&&(this._buffer=t.createBuffer(),this._generation=this._context.generation,this._isDirty=!0),t.bindBuffer(t.ARRAY_BUFFER,this._buffer),this._isDirty&&(t.bufferData(t.ARRAY_BUFFER,this._byteCount,t.DYNAMIC_DRAW),this._dirtyMin=this._totalMin,this._dirtyMax=this._totalMax,this._isDirty=!1),this._dirtyMin<this._dirtyMax&&(t.bufferSubData(t.ARRAY_BUFFER,this._dirtyMin,this._bytes.subarray(this._dirtyMin,this._dirtyMax)),this._dirtyMin=f.INT_MAX,this._dirtyMax=0)}_growDirtyRegion(t,e){this._dirtyMin=Math.min(this._dirtyMin,t),this._dirtyMax=Math.max(this._dirtyMax,e),this._totalMin=Math.min(this._totalMin,t),this._totalMax=Math.max(this._totalMax,e)}static from(t){return e(null==t||t instanceof f),t}}f.INT_MAX=2147483647;class g{constructor(t,e,i,r,s=null,n=null,a=0,o=!0,h=!0){this._context=t,this._format=e,this._width=i,this._height=r,this._pixels=s,this._texture=n,this._generation=a,this._isFormatDirty=o,this._isContentDirty=h}get context(){return this._context}get format(){return this._format}get width(){return this._width}get height(){return this._height}resize(t,e,i=null){this._width=t,this._height=e,this._pixels=i,this._isContentDirty=!0}setFormat(t){this._format!=t&&(this._format=t,this._isFormatDirty=!0)}get texture(){let t=this._context.gl;return this._generation!=this._context.generation&&(this._texture=t.createTexture(),this._generation=this._context.generation,this._isFormatDirty=!0,this._isContentDirty=!0),this._isFormatDirty&&(t.bindTexture(t.TEXTURE_2D,this._texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.format.magFilter==i.PixelFilter.NEAREST?t.NEAREST:t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.format.minFilter==i.PixelFilter.NEAREST?t.NEAREST:t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this.format.wrap==i.PixelWrap.REPEAT?t.REPEAT:t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this.format.wrap==i.PixelWrap.REPEAT?t.REPEAT:t.CLAMP_TO_EDGE),this._isFormatDirty=!1),this._isContentDirty&&(t.bindTexture(t.TEXTURE_2D,this._texture),this._pixels instanceof HTMLCanvasElement?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._pixels):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this._width,this._height,0,t.RGBA,t.UNSIGNED_BYTE,this._pixels),this._isContentDirty=!1),this._texture}free(){this.texture&&(this._context.gl.deleteTexture(this.texture),this._generation=0)}static from(t){return e(null==t||t instanceof g),t}}class p{constructor(t,e,r=null,s=0,n=!0,a=new i.Rect){this._context=t,this._texture=e,this._framebuffer=r,this._generation=s,this._isDirty=n,this._viewport=a}get context(){return this._context}get texture(){return this._texture}get viewport(){return this._viewport}setColor(t){this._texture!=t&&(this._texture=g.from(t),this._isDirty=!0)}get framebuffer(){let t=this._context.gl,i=this._texture.texture;return this._generation!=this._context.generation&&(this._framebuffer=t.createFramebuffer(),this._generation=this._context.generation,this._isDirty=!0),this._isDirty&&(t.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),e(t.checkFramebufferStatus(t.FRAMEBUFFER)==t.FRAMEBUFFER_COMPLETE),this._isDirty=!1),this._framebuffer}free(){this._framebuffer&&(this._context.gl.deleteFramebuffer(this._framebuffer),this._generation=0)}static from(t){return e(null==t||t instanceof p),t}}}(r||(r={}));const s="precision highp float;precision highp int;attribute vec2 B;const vec4 s=vec4(1.,0.,0.,1.),t=vec4(0.,1.,0.,1.),u=vec4(0.,0.,1.,1.),v=vec4(0.,0.,0.,1.),w=vec4(1.,1.,1.,1.);void main(){gl_Position=vec4(B,0,1.);}struct x{vec2 p;vec4 o;};const vec2 j=vec2(1.,0.);";var n;!function(t){t.FOR_ANOTHER_STEP={format:"seed-position",renderTarget:"texture"},t.FOR_SCREEN={format:"distance",renderTarget:"screen"}}(n||(n={})),t.DistanceFieldGenerator=class{constructor(t={}){this._sourceTexture=null,this._destTexture=null,this._sourceTextureTarget=null,this._destTextureTarget=null,this._seedInputTexture=null,null!=t.outputCanvas?this._outputCanvas=t.outputCanvas:this._outputCanvas=document.createElement("canvas");const e=null!=t.outputCanvas?[t.outputCanvas.width,t.outputCanvas.height]:null!=t.sizeHint?t.sizeHint:[100,100];this._gl=new r.Context(this._outputCanvas),this._resizeOutputCanvasAndTextures(e[0],e[1],"force-update");const n=this._gl;this._gl.setCopyBlendState();const a=new i.VertexFormat;a.add("B",i.AttributeType.FLOAT,2),this._prepJumpFloodData=n.createMaterial(a,s,"precision highp float;precision highp int;uniform sampler2D q;uniform vec2 h;const vec4 s=vec4(1.,0.,0.,1.),t=vec4(0.,1.,0.,1.),u=vec4(0.,0.,1.,1.),v=vec4(0.,0.,0.,1.),w=vec4(1.,1.,1.,1.);bool r(float a,float b,float c){return clamp(a,b,c)==a;}vec4 A(in vec2 b){vec2 a=b;a=floor(a*8.);return vec4(floor(a.x/255.),mod(a.x,255.),floor(a.y/255.),mod(a.y,255.))/255.;}vec4 m(vec2 b){vec2 a=b.xy/h,c=vec2(a.x,1.-a.y);return texture2D(q,c);}struct x{vec2 p;vec4 o;};const vec2 j=vec2(1.,0.);bool C(vec2 a,vec4 e,out x g){vec2 c=a.xy-j,d=a.xy+j;vec4 i=m(c),k=m(d);vec2 b=e.r>.5?vec2(0.,.5):vec2(.5,1.);if(r(i.r,b.x,b.y)){g=x(c,i);return true;}else if(r(k.r,b.x,b.y)){g=x(d,k);return true;}return false;}bool D(vec2 a,vec4 e,out x g){vec2 c=a.xy-j.yx,d=a.xy+j.yx;vec4 i=m(c),k=m(d);vec2 b=e.r>.5?vec2(0.,.5):vec2(.5,1.);if(r(k.r,b.x,b.y)){g=x(d,k);return true;}else if(r(i.r,b.x,b.y)){g=x(c,i);return true;}return false;}void main(){vec4 b=m(gl_FragCoord.xy);if(abs(b.r-.5)<.1)gl_FragColor=A(gl_FragCoord.xy);else{vec2 c=vec2(8129.);x a;if(C(gl_FragCoord.xy,b,a)){float d=b.r,g=a.o.r,k=abs(.5-d)/abs(g-d);c=mix(gl_FragCoord.xy,a.p,k);}if(D(gl_FragCoord.xy,b,a)){float e=b.r,i=a.o.r,E=abs(.5-e)/abs(i-e);c.x=min(c.x,gl_FragCoord.x),c.y=mix(gl_FragCoord.y,a.p.y,E);}gl_FragColor=A(c);}}"),this._jumpFloodOutputSeedPosition=n.createMaterial(a,s,"precision highp float;precision highp int;uniform sampler2D n;uniform vec2 h;uniform int y;const vec4 s=vec4(1.,0.,0.,1.),t=vec4(0.,1.,0.,1.),u=vec4(0.,0.,1.,1.),v=vec4(0.,0.,0.,1.),w=vec4(1.,1.,1.,1.);vec2 l(in vec4 a){a*=255.;return vec2(a.x*255.+a.y,a.z*255.+a.w)/8.;}struct x{vec2 p;vec4 o;};const vec2 j=vec2(1.,0.);vec4 f(in vec4 a,in vec2 c){vec2 d=(gl_FragCoord.xy+c)/h;vec4 b=texture2D(n,d);vec2 e=l(a),g=l(b);float i=distance(e,gl_FragCoord.xy),k=distance(g,gl_FragCoord.xy);return i>k?b:a;}vec4 z(in vec4 a,in int b){a=f(a,vec2(0,b)),a=f(a,vec2(b,b)),a=f(a,vec2(b,0)),a=f(a,vec2(b,-b)),a=f(a,vec2(0,-b)),a=f(a,vec2(-b,-b)),a=f(a,vec2(-b,0)),a=f(a,vec2(-b,b));return a;}void main(){vec2 a=gl_FragCoord.xy/h;vec4 b=texture2D(n,a);gl_FragColor=z(b,y);}"),this._jumpFloodOutputDistance=n.createMaterial(a,s,"precision highp float;precision highp int;uniform sampler2D q,n;uniform vec2 h;uniform int y;const vec4 s=vec4(1.,0.,0.,1.),t=vec4(0.,1.,0.,1.),u=vec4(0.,0.,1.,1.),v=vec4(0.,0.,0.,1.),w=vec4(1.,1.,1.,1.);vec2 l(in vec4 a){a*=255.;return vec2(a.x*255.+a.y,a.z*255.+a.w)/8.;}struct x{vec2 p;vec4 o;};const vec2 j=vec2(1.,0.);vec4 f(in vec4 a,in vec2 c){vec2 d=(gl_FragCoord.xy+c)/h;vec4 b=texture2D(n,d);vec2 e=l(a),g=l(b);float i=distance(e,gl_FragCoord.xy),k=distance(g,gl_FragCoord.xy);return i>k?b:a;}vec4 z(in vec4 a,in int b){a=f(a,vec2(0,b)),a=f(a,vec2(b,b)),a=f(a,vec2(b,0)),a=f(a,vec2(b,-b)),a=f(a,vec2(0,-b)),a=f(a,vec2(-b,-b)),a=f(a,vec2(-b,0)),a=f(a,vec2(-b,b));return a;}vec4 F(in float a){a*=1000.,a+=8290687.5;return vec4(mod(floor(a/65025.),255.),mod(floor(a/255.),255.),mod(floor(a),255.),255.)/255.;}void main(){vec2 a=gl_FragCoord.xy/h;vec4 b=texture2D(n,a);b=z(b,y);vec4 c=texture2D(q,vec2(a.x,1.-a.y));vec2 d=l(b);float e=distance(d,gl_FragCoord.xy),g=c.r<.5?-1.:1.;gl_FragColor=F(g*e);}");const o=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this._quadBuffer=n.createVertexBuffer(a.stride*o.length),this._quadBuffer.upload(new Uint8Array(o.buffer))}destroy(){this._sourceTexture&&this._sourceTexture.free(),this._destTexture&&this._destTexture.free(),this._seedInputTexture&&this._seedInputTexture.free(),this._quadBuffer.free(),this._prepJumpFloodData.free(),this._jumpFloodOutputDistance.free(),this._jumpFloodOutputSeedPosition.free()}outputCanvas(){return this._outputCanvas}_resizeTextureIfNecessary(t,e,i,r="dont-force"){t.width===e&&t.height===i&&"force-update"!==r||t.resize(e,i)}_resizeOutputCanvasAndTextures(t,e,r="dont-force"){const s=this._gl,n=this._outputCanvas;(n.width!==t||n.height!==e||"force-update"===r)&&s.resize(t,e,t,e),null==this._sourceTexture?(this._sourceTexture=s.createTexture(i.TextureFormat.NEAREST_CLAMP,t,e),this._sourceTextureTarget=s.createRenderTarget(this._sourceTexture)):this._resizeTextureIfNecessary(this._sourceTexture,t,e),null==this._destTexture?(this._destTexture=s.createTexture(i.TextureFormat.NEAREST_CLAMP,t,e),this._destTextureTarget=s.createRenderTarget(this._destTexture)):this._resizeTextureIfNecessary(this._destTexture,t,e),null==this._seedInputTexture?this._seedInputTexture=s.createTexture(i.TextureFormat.NEAREST_CLAMP,t,e):this._resizeTextureIfNecessary(this._seedInputTexture,t,e)}generateSDF(t,e="JFA"){const i=t.width,r=t.height;this._resizeOutputCanvasAndTextures(i,r),this._setSeedsFromCanvas(t);const s=Math.max(i,r);let a=(o=s,o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,++o/2);for(var o;a>=1;){const t=a/2<1&&"JFA"==e?n.FOR_SCREEN:n.FOR_ANOTHER_STEP;this._runJumpFloodStep(a,t),a/=2}switch(e){case"JFA":break;case"JFA+1":this._runJumpFloodStep(1,n.FOR_SCREEN);break;case"JFA+2":this._runJumpFloodStep(4,n.FOR_ANOTHER_STEP),this._runJumpFloodStep(3,n.FOR_ANOTHER_STEP),this._runJumpFloodStep(2,n.FOR_ANOTHER_STEP),this._runJumpFloodStep(1,n.FOR_SCREEN)}}getPixels(){const t=this._gl.gl,e=new Uint8Array(t.drawingBufferWidth*t.drawingBufferHeight*4);return t.readPixels(0,0,t.drawingBufferWidth,t.drawingBufferHeight,t.RGBA,t.UNSIGNED_BYTE,e),e}_setSeedsFromCanvas(t){if(!this._seedInputTexture)throw new Error("Expected _seedInputTexture to be set before calling setSeedsFromCanvas");const e=t.width,r=t.height;this._seedInputTexture.resize(e,r,t);const s=this._prepJumpFloodData;s.setUniformSampler("q",this._seedInputTexture,0),s.setUniformVec2("h",e,r),this._gl.setRenderTarget(this._sourceTextureTarget),this._gl.setViewport(0,0,e,r),this._gl.draw(i.Primitive.TRIANGLE_STRIP,s,this._quadBuffer)}_runJumpFloodStep(t,e){if(!this._sourceTexture||!this._seedInputTexture)throw new Error("Expected textures to be set before calling setSeedsFromCanvas");const{width:r,height:s}=this._outputCanvas,n="seed-position"===e.format?this._jumpFloodOutputSeedPosition:this._jumpFloodOutputDistance;n.setUniformSampler("n",this._sourceTexture,0),n.setUniformInt("y",t),n.setUniformVec2("h",r,s),"distance"===e.format&&n.setUniformSampler("q",this._seedInputTexture,1),this._gl.setRenderTarget("texture"===e.renderTarget?this._destTextureTarget:null),this._gl.setViewport(0,0,r,s),this._gl.draw(i.Primitive.TRIANGLE_STRIP,n,this._quadBuffer),this._swapBuffers()}_swapBuffers(){const t=this._sourceTexture,e=this._sourceTextureTarget;this._sourceTexture=this._destTexture,this._sourceTextureTarget=this._destTextureTarget,this._destTexture=t,this._destTextureTarget=e}},Object.defineProperty(t,"__esModule",{value:!0})}));

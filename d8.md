ğŸ«§ **StageÂ 4 â€“Â MLSâ€‘MPM â€œJelly/Sandâ€ Hotâ€‘Swap** ğŸ«§  
_Blob now toggles between liquid SPH and continuum goo that can stretch, tear, and pile like snow._

---

## 0Â Â·Â Why MLSâ€‘MPM?

| Property | SPH | **MLSâ€‘MPM** |
|----------|-----|-------------|
| Compressible liquids | âœ… | âœ… |
| Viscous goo / honey   | âš ï¸ (needs tweaks) | âœ… (Frict. & Î¼p terms) |
| Elastic solids        | âŒ | âœ… (deformation gradientÂ F) |
| Fracture / tearing    | âŒ | âœ… (threshold on |F|) |
| Sand / granular pile  | âŒ | âœ… (Druckerâ€“Prager yield) |
| GPUâ€‘friendliness      | Good | **Excellent** (grid<->particle passes rely on atomic add) |

Weâ€™ll load a trimmed fork of EAâ€™s **PBâ€‘MPM WebGPU kernels** so we get 200Â k particle performance on discrete GPUs right away.

---

## 1Â Â·Â `physicsâ€‘mpm` Package Scaffolding

```
packages/physics-mpm/
 â”œâ”€ src/
 â”‚   â”œâ”€ components.ts
 â”‚   â”œâ”€ MpmSystem.ts
 â”‚   â”œâ”€ gpu/
 â”‚   â”‚   â”œâ”€ mpm-p2g.wgsl
 â”‚   â”‚   â”œâ”€ mpm-grid.wgsl
 â”‚   â”‚   â””â”€ mpm-g2p.wgsl
 â””â”€ package.json
```

**components.ts**

```ts
import { defineComponent, Types } from 'bitecs';
export const Position   = defineComponent({ x:Types.f32, y:Types.f32, z:Types.f32 });
export const Velocity   = defineComponent({ x:Types.f32, y:Types.f32, z:Types.f32 });
export const Fgrad      = defineComponent({ xx:Types.f32, xy:Types.f32, â€¦ /*9 entries*/ });
export const MaterialId = defineComponent({ id:Types.ui16 });  // 0=fluid,1=jelly,2=sand
```

`package.json` mirrors `physicsâ€‘sph`.

---

## 2Â Â·Â Import PBâ€‘MPM kernels

1. `git submodule add https://github.com/ea-webgpu/pb-mpm external/pb-mpm`  
2. Copy `src/shaders/mpm_*.wgsl` into `packages/physics-mpm/src/gpu/`.  
3. Trim to 3â€‘pipeline version (P2G, grid solver, G2P).  
4. Replace EAâ€™s `AtomicF32` helper with builtâ€‘in WGSL atomics (Chrome 124+).  

Tie them into `MpmSystem.ts`:

```ts
import { registerComputePipeline } from '@blobverse/ecs-core/gpu';
import mpmP2G from './gpu/mpm-p2g.wgsl?raw';
import mpmGrid from './gpu/mpm-grid.wgsl?raw';
import mpmG2P from './gpu/mpm-g2p.wgsl?raw';

export class MpmSystem {
  constructor() {
    registerComputePipeline('mpm-p2g', mpmP2G, { workgroup:128 });
    registerComputePipeline('mpm-grid', mpmGrid,{ workgroup:[8,8,1] });
    registerComputePipeline('mpm-g2p', mpmG2P, { workgroup:128 });
  }
  execute() { /* nothing â€“ compute pass scheduled by engine */ }
}
register(MpmSystem);
```

---

## 3Â Â·Â Hotâ€‘swap API (SPHÂ â†”Â MPM)

Expose in `@blobverse/ecs-core`:

```ts
export const enableSystem = (Sys: any) => { /* push to world.systems */ };
export const disableSystem = (Sys: any) => { /* splice out */ };
```

In UI:

```ts
const { mode } = useControls({ mode:{options:['sph','mpm']}});
useEffect(()=>{
  mode==='sph'
    ? (enableSystem(SphSystem), disableSystem(MpmSystem))
    : (enableSystem(MpmSystem), disableSystem(SphSystem));
},[mode]);
```

Particles created with `MaterialId.id = 0` for fluid or `1` for jelly decide material response inside the WGSL kernels.

---

## 4Â Â·Â Visualizer tweaks

* **Points**: colour by `MaterialId` (blueÂ fluid, pinkÂ jelly, tanÂ sand).  
* **Rayâ€‘march**: sample both SPH distance texture *and* MPM grid SDF (EA code outputs 3â€‘D grid of `Ï†`). Blend via `min()`.

---

## 5Â Â·Â Leva controls for MLSâ€‘MPM

`physics-mpm/metadata.json`

```json
{
  "displayName": "MLSâ€‘MPM",
  "controls": {
    "youngModulus": { "value": 400, "min": 50, "max": 1000 },
    "poissonRatio": { "value": 0.2, "min": 0.01, "max": 0.48 },
    "yield":        { "value": 2,   "min": 0,   "max": 10 },
    "plasticHardening": { "value": 10, "min":0, "max":30 }
  }
}
```

Uniform buffer structs in WGSL map 1â€‘toâ€‘1, updated through zustand.

---

## 6Â Â·Â Docs & Demos

* **Storybook:** `MpmJelly.stories.tsx` â€“ spawn a cube of jelly and drop it.  
* **MDX:** `milestoneâ€‘3â€‘mpm.mdx` â€“ derivation of MLSâ€‘MPM transfer equations, link to EA paper.

---

## 7Â Â·Â Performance sanity

| Target | Particles | FPSÂ (M1 MBP) |
|--------|-----------|-------------|
| SPH GPU | 10Â k | 120 |
| MPM GPU | 60Â k | 60 |
| Rayâ€‘march mesh | 512Ã—512 SDF | 1.2Â ms |

If FPS <Â 30, halve `gridSize` in `mpmGrid` pipeline.

---

## 8Â Â·Â Commit plan

```bash
git add packages/physics-mpm apps/dashboard-app ...
git commit -m "feat: MLSâ€‘MPM module & hotâ€‘swap UI"
git push origin main
```

CI deploys `/mpm` preview (WebGPU only). Paste link here for validation; weâ€™ll then iterate on fracture or sand yield and move to **StageÂ 5 â€“ Reactionâ€‘Diffusion Skin**.

---

Give me a âœ… when the new module compiles (or any build errors) and Blobby will gain its stretchâ€‘andâ€‘squish superpowers! ğŸ«§ğŸ’ª